#!/usr/bin/env perl

use warnings;
use strict;
use Data::Dumper;
use DBI;
use FindBin qw($Bin $Script);

use lib "$Bin/../lib";
use Outspam;

my $conf = {
  'domain' => '',
  'mynet' => '',
  'db' => '',
  'dbhost' => '',
  'dbuser'=> '',
  'dbpassword' => '',
  'mistrust' => '',
  'msgs_sec' => '',
  'ignore_sender' => '',
  'sndr_ip_mistrust' => '',
};

my $verbose = grep (/--verbose/, @ARGV) ? 1 : 0;

my $config_file = "$Bin/../etc/outspam.conf";
read_config($config_file,$conf);

#print Dumper($conf->{'sndr_ip_mistrust'}); die;

my $conn = db_connect($conf);



msg_sec_test();


sub msg_sec_test {
    foreach my $sec (sort { $a <=> $b } keys %{$conf->{'msgs_sec'}} ) {
        print "=== $sec\n";
        my $qstr = "select distinct replace(sndr,\'\@$conf->{'domain'}\',\'\') as sndr, count(rcpt) as nsent ".
        "from maillog m1 where outgo=1 and unix_timestamp()-m1.time < " .$sec.
        " and not exists (select * from maillog m2 where m2.sndr=m1.rcpt) and not exists ".
        "(select * from maillog m3 where m3.rcpt=m1.rcpt and m3.msg != m1.msg and stat=\'sent\') group by sndr";

        my $q = $conn->prepare($qstr);
        $q->execute() or query_err($conn,$qstr);

        while ( my $r  = $q->fetchrow_hashref() ) {

            my $coef = $conf->{'mistrust'}->{$r->{'sndr'}};
            $coef = 1 unless defined $coef;
            my $score = $r->{'nsent'} * $coef * sndr_ip_mistrust($r->{'sndr'},$sec); 
            print "$r->{'sndr'} $r->{'nsent'} \($score\) require $conf->{'msgs_sec'}->{$sec}";
            if ( $score > $conf->{'msgs_sec'}->{$sec} ) {
                print " *** ban ***\n";
            } else { print "\n"; }   
        }
    }    
}

# вес получателей yahoo большой, а ac.ru маленький. Вообще можно игнорирвоать некоторые адреса
# рабочее - нерабочее время. Это видно по активности получателей почты.
# Проводить проверку только убедившись, что очередь свободна или что-то в этом роде (есть входящая почта?)
# реакция на defer и reject

sub sndr_ip_mistrust {
    (my $sndr, my$sec) = @_;
    my $qstr = "select sndr, relay from maillog where outgo=1 and sndr=\'$sndr\@$conf->{'domain'}\'".
              " and unix_timestamp()-time < $sec group by sndr,relay";

    my $q = $conn->prepare($qstr);
    $q->execute() or query_err($conn,$qstr);

    my $alien_ip_count = 0;
    while ( my $r  = $q->fetchrow_hashref() ) {
       $alien_ip_count++ unless in_netblock($r->{'relay'},($conf->{'mynet'},$conf->{'friendnet'}));
    }    
    return $conf->{'sndr_ip_mistrust'}->{'base'} ** $alien_ip_count;
}    

#sub sndr_ip_test {
#   select sndr,count(distinct relay) as nrelay from maillog where outgo=1 group by sndr having count(distinct relay) > 1 order by 2 desc; 
#} 

